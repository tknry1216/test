name: Toggle Billing Mode

on:
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      billing_mode:
        description: 'IS_PREPARING_BILLING_MODE ã®å€¤'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Update IS_PREPARING_BILLING_MODE
        run: |
          # k8s/hoge.yaml ã® IS_PREPARING_BILLING_MODE ã‚’æ›´æ–°
          sed -i 's/\(IS_PREPARING_BILLING_MODE\)$/\1/' k8s/hoge.yaml
          sed -i '/IS_PREPARING_BILLING_MODE/{n;s/value: ".*"/value: "${{ inputs.billing_mode }}"/}' k8s/hoge.yaml
          
          echo "âœ… IS_PREPARING_BILLING_MODE ã‚’ ${{ inputs.billing_mode }} ã«å¤‰æ›´ã—ã¾ã—ãŸ"
          
          # å¤‰æ›´å†…å®¹ã‚’ç¢ºèª
          grep -A1 "IS_PREPARING_BILLING_MODE" k8s/hoge.yaml
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: set IS_PREPARING_BILLING_MODE to ${{ inputs.billing_mode }}"
          branch: feature/billing-mode-${{ inputs.billing_mode }}
          delete-branch: true
          title: "ğŸ”§ IS_PREPARING_BILLING_MODE ã‚’ ${{ inputs.billing_mode }} ã«å¤‰æ›´"
          body: |
            ## å¤‰æ›´å†…å®¹
            
            `IS_PREPARING_BILLING_MODE` ã‚’ `${{ inputs.billing_mode }}` ã«å¤‰æ›´ã—ã¾ã™ã€‚
            
            ### å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
            - `k8s/hoge.yaml`
            
            ### å¤‰æ›´ç®‡æ‰€
            ```yaml
            - name: IS_PREPARING_BILLING_MODE
              value: "${{ inputs.billing_mode }}"
            ```
            
            ---
            ğŸ¤– ã“ã®PRã¯GitHub Actionsã«ã‚ˆã£ã¦è‡ªå‹•ä½œæˆã•ã‚Œã¾ã—ãŸã€‚
          labels: |
            automated
            config-change

