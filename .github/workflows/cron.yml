name: Toggle Billing Mode

on:
  schedule:
    # æ¯æœˆ1æ—¥ 0:00 (æ—¥æœ¬æ™‚é–“) = UTC å‰æœˆæœ«æ—¥ 15:00
    # 28-31æ—¥ã®15:00 UTCã«å®Ÿè¡Œã—ã€ç¿Œæ—¥ãŒæœˆåˆã‹ãƒã‚§ãƒƒã‚¯
    - cron: '0 15 28-31 * *'
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      billing_mode:
        description: 'IS_PREPARING_BILLING_MODE ã®å€¤'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-slim
    
    steps:
      - name: Check if tomorrow is the first day of the month
        id: check-date
        run: |
          # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œã®å ´åˆã€ç¿Œæ—¥ãŒæœˆåˆã‹ãƒã‚§ãƒƒã‚¯
          if [ "${{ github.event_name }}" = "schedule" ]; then
            TOMORROW=$(date -u -d "+9 hours +1 day" +%d)
            if [ "$TOMORROW" = "01" ]; then
              echo "is_first_day=true" >> $GITHUB_OUTPUT
              echo "ğŸ“… æ˜æ—¥ã¯æœˆåˆã§ã™ã€‚PRã‚’ä½œæˆã—ã¾ã™ã€‚"
            else
              echo "is_first_day=false" >> $GITHUB_OUTPUT
              echo "â­ï¸ æ˜æ—¥ã¯æœˆåˆã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            fi
          else
            # æ‰‹å‹•å®Ÿè¡Œã®å ´åˆã¯å¸¸ã«å®Ÿè¡Œ
            echo "is_first_day=true" >> $GITHUB_OUTPUT
            echo "ğŸ–±ï¸ æ‰‹å‹•å®Ÿè¡Œã§ã™ã€‚"
          fi

      - name: Checkout repository
        if: steps.check-date.outputs.is_first_day == 'true'
        uses: actions/checkout@v4

      - name: Determine billing mode value
        if: steps.check-date.outputs.is_first_day == 'true'
        id: billing-value
        run: |
          # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œã®å ´åˆã¯trueã€æ‰‹å‹•å®Ÿè¡Œã®å ´åˆã¯å…¥åŠ›å€¤
          if [ "${{ github.event_name }}" = "schedule" ]; then
            echo "value=true" >> $GITHUB_OUTPUT
          else
            echo "value=${{ inputs.billing_mode }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Update IS_PREPARING_BILLING_MODE
        if: steps.check-date.outputs.is_first_day == 'true'
        run: |
          # k8s/hoge.yaml ã® IS_PREPARING_BILLING_MODE ã‚’æ›´æ–°
          sed -i '/IS_PREPARING_BILLING_MODE/{n;s/value: ".*"/value: "${{ steps.billing-value.outputs.value }}"/}' k8s/hoge.yaml
          
          echo "âœ… IS_PREPARING_BILLING_MODE ã‚’ ${{ steps.billing-value.outputs.value }} ã«å¤‰æ›´ã—ã¾ã—ãŸ"
          
          # å¤‰æ›´å†…å®¹ã‚’ç¢ºèª
          grep -A1 "IS_PREPARING_BILLING_MODE" k8s/hoge.yaml
      
      - name: Create Pull Request
        if: steps.check-date.outputs.is_first_day == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: set IS_PREPARING_BILLING_MODE to ${{ steps.billing-value.outputs.value }}"
          branch: feature/billing-mode-${{ steps.billing-value.outputs.value }}
          delete-branch: true
          title: "ğŸ”§ IS_PREPARING_BILLING_MODE ã‚’ ${{ steps.billing-value.outputs.value }} ã«å¤‰æ›´"
          body: |
            ## å¤‰æ›´å†…å®¹
            
            `IS_PREPARING_BILLING_MODE` ã‚’ `${{ steps.billing-value.outputs.value }}` ã«å¤‰æ›´ã—ã¾ã™ã€‚
            
            ### å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
            - `k8s/hoge.yaml`
            
            ### å¤‰æ›´ç®‡æ‰€
            ```yaml
            - name: IS_PREPARING_BILLING_MODE
              value: "${{ steps.billing-value.outputs.value }}"
            ```
            
            ---
            ğŸ¤– ã“ã®PRã¯GitHub Actionsã«ã‚ˆã£ã¦è‡ªå‹•ä½œæˆã•ã‚Œã¾ã—ãŸã€‚
          labels: |
            automated
            config-change

